<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Mess - Чат</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Настройка шрифта Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate-900 */
        }
        /* Кастомный скроллбар для стилизации под темный фон */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="relative min-h-screen">
        <!-- Анимированный фон (LiquidBackground) -->
        <div id="liquid-bg" class="fixed inset-0 overflow-hidden -z-10"></div>
        
        <!-- Основное содержимое будет рендериться здесь -->
        <div id="main-content" class="relative z-10">
            <!-- Экраны будут заменены JavaScript'ом -->
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            updateProfile,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            serverTimestamp,
            orderBy,
            limit,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'liquid-mess-default';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentScreen = 'auth'; // 'auth', 'welcome', 'chatList', 'chat'
        let activeChat = null; // { id, name, type, targetId }
        let currentUserId = null;
        let isAuthReady = false;

        const mainContent = document.getElementById('main-content');
        
        // --- UTILS ---

        // Создание элемента с атрибутами и классами
        const createElement = (tag, attributes = {}, classes = [], content = '') => {
            const el = document.createElement(tag);
            Object.entries(attributes).forEach(([key, value]) => el.setAttribute(key, value));
            if (classes.length > 0) el.className = classes.join(' ');
            if (content) el.innerHTML = content;
            return el;
        };
        
        // Создание SVG-иконки
        const createIcon = (name, size = 20, classes = []) => {
            const svg = lucide.createIcons()[name];
            if (!svg) return createElement('span', {}, [], name);
            const span = createElement('span', { 'data-lucide': name }, classes, svg.toSvg({ width: size, height: size }));
            return span;
        };

        // Запуск анимации Liquid Background
        const setupLiquidBackground = () => {
            const bg = document.getElementById('liquid-bg');
            bg.innerHTML = `
                <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-600 rounded-full mix-blend-multiply filter blur-[100px] opacity-70 animate-blob1"></div>
                <div class="absolute top-[20%] right-[-10%] w-[400px] h-[400px] bg-blue-600 rounded-full mix-blend-multiply filter blur-[100px] opacity-70 animate-blob2"></div>
                <div class="absolute bottom-[-10%] left-[20%] w-[600px] h-[600px] bg-pink-600 rounded-full mix-blend-multiply filter blur-[100px] opacity-70 animate-blob3"></div>
            `;
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes blob1 {
                    0%, 100% { transform: translate(0px, 0px) scale(1); }
                    33% { transform: translate(100px, -50px) scale(1.2); }
                    66% { transform: translate(-50px, 100px) scale(0.8); }
                }
                @keyframes blob2 {
                    0%, 100% { transform: translate(0px, 0px) scale(1); }
                    33% { transform: translate(-100px, 100px) scale(1.5); }
                    66% { transform: translate(50px, -50px) scale(0.9); }
                }
                @keyframes blob3 {
                    0%, 100% { transform: translate(0px, 0px) scale(1); }
                    33% { transform: translate(50px, -100px) scale(0.8); }
                    66% { transform: translate(-100px, 50px) scale(1.2); }
                }
                .animate-blob1 { animation: blob1 20s infinite linear; }
                .animate-blob2 { animation: blob2 15s infinite linear; }
                .animate-blob3 { animation: blob3 18s infinite linear; }
            `;
            document.head.appendChild(style);
        };
        
        // Генерация ID для приватного чата
        const getPrivateChatId = (uid1, uid2) => {
            return [uid1, uid2].sort().join('_');
        };

        // Индексация метаданных пользователя для поиска
        const indexUserMetadata = async (user) => {
            if (!user || !user.displayName) return;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_metadata', user.uid);
            try {
                await setDoc(userRef, {
                    uid: user.uid,
                    nickname: user.displayName.toLowerCase(),
                    originalNickname: user.displayName,
                    email: user.email,
                }, { merge: true });
            } catch (e) {
                console.error("Ошибка индексации пользователя:", e);
            }
        };

        // --- STATE MANAGEMENT & RENDERING ---

        const navigateTo = (screen, chat = null) => {
            currentScreen = screen;
            activeChat = chat;
            renderApp();
        };

        const updateCurrentUser = (user) => {
            currentUser = user;
            currentUserId = user ? user.uid : null;
            if (user && !user.displayName) {
                showNicknameSetupModal(true);
            }
        };

        const renderApp = () => {
            mainContent.innerHTML = '';
            
            if (!isAuthReady) {
                mainContent.appendChild(renderLoading());
                return;
            }

            if (!currentUser) {
                mainContent.appendChild(renderAuthScreen());
            } else if (!currentUser.displayName) {
                // Если нет никнейма, принудительно показываем модалку
                mainContent.appendChild(renderNicknameSetupModal(true));
            } else if (activeChat) {
                mainContent.appendChild(renderChatScreen());
            } else if (currentScreen === 'chatList') {
                mainContent.appendChild(renderChatListScreen());
            } else {
                // 'welcome' screen
                mainContent.appendChild(renderWelcomeScreen());
            }
        };

        // --- AUTH LOGIC ---

        const handleAuthSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const email = form.email.value;
            const password = form.password.value;
            const nickname = form.nickname.value;
            const errorElement = document.getElementById('auth-error');
            
            errorElement.innerHTML = '';
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>`;

            try {
                // 1. Попытка входа
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await indexUserMetadata(userCredential.user);
                
            } catch (err) {
                // 2. Если вход не удался (user-not-found, invalid-credential) - пробуем зарегистрировать
                if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    if (!nickname.trim()) {
                        errorElement.innerHTML = "Аккаунт не найден. Для регистрации придумайте никнейм.";
                        return; // Прерываем выполнение
                    }

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCredential.user, { displayName: nickname.trim() });
                        await indexUserMetadata(userCredential.user);
                    } catch (regError) {
                        let msg = "Ошибка регистрации.";
                        if (regError.code === 'auth/email-already-in-use') msg = "Эта почта уже занята!";
                        if (regError.code === 'auth/weak-password') msg = "Пароль слишком простой (мин. 6 символов).";
                        if (regError.code === 'auth/operation-not-allowed') msg = "Ошибка: Email/Password вход не включен в настройках Firebase.";
                        errorElement.innerHTML = msg;
                    }
                } else {
                    // Другие ошибки входа
                    let msg = "Ошибка входа.";
                    if (err.code === 'auth/wrong-password') msg = "Неверный пароль.";
                    if (err.code === 'auth/invalid-email') msg = "Некорректный формат почты.";
                    if (err.code === 'auth/operation-not-allowed') msg = "Ошибка: Email/Password вход не включен в настройках Firebase.";
                    errorElement.innerHTML = msg;
                }
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `Войти или Зарегистрироваться ${createIcon('ArrowRight', 20).outerHTML}`;
            }
        };

        // --- UI SCREENS ---

        const renderLoading = () => {
            const div = createElement('div', {}, ['h-screen', 'w-screen', 'flex', 'items-center', 'justify-center', 'text-white']);
            div.innerHTML = `<div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div>`;
            return div;
        };

        const renderAuthScreen = () => {
            const container = createElement('div', {}, ['flex', 'items-center', 'justify-center', 'min-h-screen', 'p-4']);
            const card = createElement('div', {}, [
                'w-full', 'max-w-md', 'bg-white/10', 'backdrop-blur-xl', 'border', 
                'border-white/20', 'p-8', 'rounded-3xl', 'shadow-2xl', 'relative', 'overflow-hidden'
            ]);

            card.innerHTML = `
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500"></div>
                
                <div class="flex flex-col items-center mb-8">
                    <div class="bg-white/20 p-4 rounded-full mb-4 shadow-inner ring-1 ring-white/30">
                        ${createIcon('Droplets', 40, ['text-white']).outerHTML}
                    </div>
                    <h1 class="text-4xl font-bold text-white tracking-tight">Liquid Mess</h1>
                    <p class="text-blue-200 mt-2 text-sm uppercase tracking-widest opacity-80">
                        Добро пожаловать! Войдите или Зарегистрируйтесь
                    </p>
                </div>

                <form id="auth-form" class="space-y-4">
                    <div class="relative group">
                        ${createIcon('Mail', 20, ['absolute', 'left-4', 'top-1/2', '-translate-y-1/2', 'text-white/50', 'group-focus-within:text-white', 'transition-colors']).outerHTML}
                        <input type="email" name="email" placeholder="Email (почта)" required
                            class="w-full bg-black/20 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white placeholder-white/30 focus:outline-none focus:bg-black/30 focus:border-white/30 transition-all"
                        />
                    </div>

                    <div class="relative group">
                        ${createIcon('Lock', 20, ['absolute', 'left-4', 'top-1/2', '-translate-y-1/2', 'text-white/50', 'group-focus-within:text-white', 'transition-colors']).outerHTML}
                        <input type="password" name="password" placeholder="Пароль" required
                            class="w-full bg-black/20 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white placeholder-white/30 focus:outline-none focus:bg-black/30 focus:border-white/30 transition-all"
                        />
                    </div>
                    
                    <div class="relative group">
                        ${createIcon('User', 20, ['absolute', 'left-4', 'top-1/2', '-translate-y-1/2', 'text-white/50', 'group-focus-within:text-white', 'transition-colors']).outerHTML}
                        <input type="text" name="nickname" placeholder="Никнейм (только для регистрации)"
                            class="w-full bg-black/20 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white placeholder-white/30 focus:outline-none focus:bg-black/30 focus:border-white/30 transition-all"
                        />
                    </div>

                    <div id="auth-error" class="text-red-300 text-sm text-center bg-red-500/20 py-2 rounded-lg border border-red-500/30 h-10 flex items-center justify-center"></div>

                    <button type="submit"
                        class="w-full mt-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-purple-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
                    >
                        Войти или Зарегистрироваться ${createIcon('ArrowRight', 20).outerHTML}
                    </button>
                    <p class="text-xs text-red-300 mt-3 text-center">
                        * Если вы видите ошибку "auth/operation-not-allowed", включите вход по Email/Password в настройках Firebase.
                    </p>
                </form>
            `;
            container.appendChild(card);
            card.querySelector('#auth-form').addEventListener('submit', handleAuthSubmit);
            return container;
        };

        const renderWelcomeScreen = () => {
            const container = createElement('div', {}, ['flex', 'items-center', 'justify-center', 'min-h-screen', 'p-4']);
            const card = createElement('div', {}, [
                'w-full', 'max-w-md', 'bg-white/10', 'backdrop-blur-xl', 'border', 
                'border-white/20', 'p-10', 'rounded-3xl', 'shadow-2xl', 'relative', 'text-center'
            ]);

            const userInitial = (currentUser.displayName?.[0] || currentUser.email?.[0])?.toUpperCase() || '?';

            card.innerHTML = `
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-400 via-cyan-400 to-blue-400"></div>

                <div class="flex flex-col items-center mb-8">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-cyan-400 to-blue-500 flex items-center justify-center text-white font-extrabold text-3xl shadow-xl mb-4">
                        ${userInitial}
                    </div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">
                        Добро пожаловать, ${currentUser.displayName}!
                    </h1>
                    <p class="text-blue-200 mt-2 text-base">
                        Вы успешно авторизованы.
                    </p>
                </div>

                <div class='flex flex-col gap-3 mt-6'>
                    <button id="btn-enter-chats"
                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-500/30 transition-all transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center gap-2"
                    >
                        Войти ${createIcon('ArrowRight', 20).outerHTML}
                    </button>

                    <button id="btn-show-settings"
                        class="w-full bg-slate-700/50 hover:bg-slate-700/80 text-white font-semibold py-3 rounded-xl transition-all flex items-center justify-center gap-2 border border-white/10"
                    >
                        ${createIcon('Settings', 20).outerHTML} Настройки (Сменить Никнейм)
                    </button>
                    
                    <button id="btn-logout"
                        class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-500/30 transition-all flex items-center justify-center gap-2"
                    >
                        ${createIcon('LogOut', 20).outerHTML} Выход
                    </button>
                </div>
            `;
            container.appendChild(card);
            card.querySelector('#btn-enter-chats').addEventListener('click', () => navigateTo('chatList'));
            card.querySelector('#btn-show-settings').addEventListener('click', () => showNicknameSetupModal(false));
            card.querySelector('#btn-logout').addEventListener('click', () => signOut(auth));
            return container;
        };

        // --- NICKNAME MODAL LOGIC & RENDER ---

        const handleNicknameSetup = async (e) => {
            e.preventDefault();
            const form = e.target;
            const nickname = form.nickname.value.trim();
            const errorElement = document.getElementById('nickname-error');
            
            if (!nickname) {
                errorElement.textContent = "Пожалуйста, придумайте никнейм.";
                return;
            }

            errorElement.textContent = '';
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>`;

            try {
                await updateProfile(currentUser, { displayName: nickname });
                await indexUserMetadata(currentUser);
                
                // Обновляем текущего пользователя в глобальном стейте
                updateCurrentUser(auth.currentUser); 
                
                // Закрываем модальное окно и перерисовываем
                showNicknameSetupModal(false); 
                
            } catch (err) {
                console.error(err);
                errorElement.textContent = "Ошибка сохранения никнейма. Попробуйте снова.";
            } finally {
                submitButton.disabled = false;
                // Не обновляем текст кнопки, так как стейт изменится и компонент перерисуется
            }
        };

        const showNicknameSetupModal = (isSetupRequired) => {
            const modal = renderNicknameSetupModal(isSetupRequired);
            // Принудительно вставляем модальное окно поверх текущего экрана
            const appContainer = document.getElementById('app-container');
            
            // Проверяем, существует ли уже модалка
            if (document.getElementById('nickname-modal-overlay')) {
                document.getElementById('nickname-modal-overlay').remove();
            }

            appContainer.appendChild(modal);

            // Закрытие модалки по клику вне (только если не обязательный setup)
            if (!isSetupRequired) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        renderApp(); // Перерисовываем основной экран
                    }
                });
                modal.querySelector('#btn-nickname-close').addEventListener('click', () => {
                    modal.remove();
                    renderApp(); 
                });
            }

            modal.querySelector('#nickname-form').addEventListener('submit', handleNicknameSetup);
        };

        const renderNicknameSetupModal = (isSetupRequired) => {
            const tempNickname = currentUser.email?.split('@')[0] || '';
            const initialNickname = currentUser.displayName || tempNickname;
            
            const overlay = createElement('div', { id: 'nickname-modal-overlay' }, [
                'fixed', 'inset-0', 'bg-black/70', 'flex', 'items-center', 'justify-center', 'p-4', 'z-50'
            ]);
            
            const card = createElement('div', {}, [
                'w-full', 'max-w-md', 'bg-slate-900/90', 'backdrop-blur-xl', 'border', 
                'border-white/20', 'p-8', 'rounded-3xl', 'shadow-2xl', 'relative', 'overflow-hidden'
            ]);

            card.innerHTML = `
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 via-pink-500 to-red-500"></div>
                
                ${!isSetupRequired ? `<button id="btn-nickname-close" class="absolute top-4 right-4 text-white/70 hover:text-white transition-colors p-1">${createIcon('X', 20).outerHTML}</button>` : ''}

                <div class="flex flex-col items-center mb-8">
                    ${createIcon('Settings', 40, ['text-white', 'mb-2']).outerHTML}
                    <h1 class="text-2xl font-bold text-white tracking-tight">
                        ${isSetupRequired ? "Придумайте Никнейм" : "Изменить Никнейм"}
                    </h1>
                    <p class="text-blue-200 mt-2 text-sm uppercase tracking-widest opacity-80">
                        ${isSetupRequired ? "Обязательный шаг для начала" : "Ваши настройки профиля"}
                    </p>
                </div>

                <form id="nickname-form" class="space-y-6">
                    <div class="relative group">
                        ${createIcon('User', 20, ['absolute', 'left-4', 'top-1/2', '-translate-y-1/2', 'text-white/50', 'group-focus-within:text-white', 'transition-colors']).outerHTML}
                        <input
                            type="text"
                            name="nickname"
                            placeholder="Ваш Никнейм"
                            value="${initialNickname}"
                            oninput="this.value = this.value.slice(0, 30)"
                            maxlength="30"
                            required
                            class="w-full bg-black/20 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white placeholder-white/30 focus:outline-none focus:bg-black/30 focus:border-white/30 transition-all"
                        />
                    </div>
                    
                    <div id="nickname-error" class="text-red-300 text-sm text-center h-5"></div> 

                    <button type="submit"
                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-purple-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
                    >
                        ${isSetupRequired ? "Сохранить и войти" : "Сохранить изменения"} ${createIcon('Sparkles', 20).outerHTML}
                    </button>
                    
                    ${!isSetupRequired ? `
                        <button type="button" id="btn-nickname-close"
                            class="w-full text-white/70 hover:text-white mt-2 p-2 transition-colors"
                        >
                            Отмена
                        </button>
                    ` : ''}
                </form>
            `;
            overlay.appendChild(card);
            return overlay;
        };

        // --- CHAT LIST & SEARCH LOGIC & RENDER ---

        let chatUnsubscribe = null;
        let chatList = [];
        let searchResults = [];

        const subscribeToChats = () => {
            if (chatUnsubscribe) chatUnsubscribe(); // Отписываемся от старой подписки
            if (!currentUserId) return;

            const chatsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
            const q = query(chatsRef, where('members', 'array-contains', currentUserId), orderBy('updatedAt', 'desc'));

            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                chatList = [];
                snapshot.forEach((doc) => {
                    const chatData = doc.data();
                    let displayName = chatData.name;
                    let targetId = null;

                    if (chatData.type === 'private') {
                        targetId = chatData.members.find(uid => uid !== currentUserId);
                        displayName = chatData.memberNames[targetId] || 'Неизвестный пользователь';
                    }
                    
                    chatList.push({ ...chatData, id: doc.id, name: displayName, targetId: targetId });
                });
                renderApp(); // Перерисовываем, чтобы обновить список чатов
            }, (error) => {
                console.error("Ошибка при получении списка чатов:", error);
            });
        };
        
        const searchUsers = async (queryText) => {
            const searchResultsContainer = document.getElementById('search-results-container');
            if (!searchResultsContainer) return;
            searchResultsContainer.innerHTML = '';
            
            if (queryText.length < 3) {
                searchResults = [];
                return;
            }

            searchResultsContainer.innerHTML = `<p class="text-white/50 text-center">Поиск...</p>`;
            
            const qText = queryText.toLowerCase();
            
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users_metadata');
                const q = query(
                    usersRef, 
                    where('nickname', '>=', qText), 
                    where('nickname', '<=', qText + '\uf7ff'),
                    limit(10)
                );
                
                const snapshot = await getDocs(q);
                searchResults = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.uid !== currentUserId) { 
                        searchResults.push(data);
                    }
                });
                
                renderSearchResults(searchResultsContainer);

            } catch (error) {
                console.error("Ошибка поиска пользователей:", error);
            }
        };

        const renderSearchResults = (container) => {
            container.innerHTML = ''; // Очищаем 'Поиск...'
            
            if (searchResults.length === 0) {
                container.innerHTML = `<p class="text-white/50 text-center">Пользователи не найдены.</p>`;
                return;
            }

            const header = createElement('h3', {}, ['text-sm', 'font-semibold', 'text-purple-300', 'mb-2'], `Результаты поиска (${searchResults.length})`);
            container.appendChild(header);

            searchResults.forEach(user => {
                const item = createElement('div', { 'data-uid': user.uid }, [
                    'flex', 'justify-between', 'items-center', 'p-3', 'hover:bg-white/10', 'rounded-lg', 'cursor-pointer', 'transition-colors', 'mt-1'
                ]);

                const userInitial = user.originalNickname?.[0]?.toUpperCase() || '?';

                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-sm">
                            ${userInitial}
                        </div>
                        <span class="text-white font-semibold">${user.originalNickname}</span>
                    </div>
                    ${createIcon('MessageSquare', 18, ['text-cyan-400']).outerHTML}
                `;
                
                item.addEventListener('click', () => handleStartPrivateChat(user));
                container.appendChild(item);
            });
        };
        
        const handleSearchInputChange = (e) => {
            const queryText = e.target.value.trim();
            if (queryText.length >= 3) {
                // Делаем поиск с небольшой задержкой (debounce)
                clearTimeout(e.target.searchTimeout);
                e.target.searchTimeout = setTimeout(() => searchUsers(queryText), 300);
            } else {
                // Если запрос слишком короткий, очищаем результаты
                searchResults = [];
                const container = document.getElementById('search-results-container');
                if(container) container.innerHTML = '';
            }
        };

        const handleStartPrivateChat = async (targetUser) => {
            const targetId = targetUser.uid;
            const chatId = getPrivateChatId(currentUserId, targetId);
            const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
            
            // Создаем/обновляем метаданные чата
            const chatData = {
                id: chatId,
                type: 'private',
                members: [currentUserId, targetId],
                memberNames: {
                    [currentUserId]: currentUser.displayName,
                    [targetId]: targetUser.originalNickname
                },
                lastMessage: '',
                updatedAt: serverTimestamp(),
            };
            await setDoc(chatRef, chatData, { merge: true });

            // Переходим в чат
            navigateTo('chat', { 
                ...chatData, 
                name: targetUser.originalNickname, 
                targetId: targetId 
            });
        };

        const handleChatListItemClick = (chat) => {
            navigateTo('chat', chat);
        };
        
        const handleCreateGroup = async (groupName) => {
            const groupsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
            const newGroupRef = await addDoc(groupsRef, {
                name: groupName.trim(),
                type: 'group',
                creatorId: currentUserId,
                members: [currentUserId], // Только создатель
                memberNames: { [currentUserId]: currentUser.displayName },
                lastMessage: 'Группа создана.',
                updatedAt: serverTimestamp(),
            });

            const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', newGroupRef.id, 'messages');
            await addDoc(messagesRef, {
                text: `Группа "${groupName}" создана пользователем ${currentUser.displayName}.`,
                createdAt: serverTimestamp(),
                senderId: currentUserId,
                senderName: 'Система',
            });
            
            // Автоматический переход в созданную группу
            navigateTo('chat', { 
                id: newGroupRef.id, 
                name: groupName.trim(), 
                type: 'group',
                members: [currentUserId]
            });
        };

        const renderCreateGroupModal = () => {
            const overlay = createElement('div', { id: 'group-modal-overlay' }, [
                'fixed', 'inset-0', 'bg-black/70', 'flex', 'items-center', 'justify-center', 'p-4', 'z-50'
            ]);
            
            const card = createElement('div', {}, [
                'w-full', 'max-w-lg', 'bg-slate-900/90', 'backdrop-blur-xl', 'border', 
                'border-white/20', 'p-8', 'rounded-3xl', 'shadow-2xl', 'relative', 'overflow-hidden'
            ]);

            card.innerHTML = `
                <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-3">
                    <h2 class="text-2xl font-bold text-white tracking-tight flex items-center gap-2">
                        ${createIcon('Users', 24, ['text-purple-400']).outerHTML} Создать Новую Группу
                    </h2>
                    <button id="btn-group-close" class="text-white/70 hover:text-white">${createIcon('X', 20).outerHTML}</button>
                </div>
                
                <form id="group-form" class="space-y-6">
                    <div class="relative group">
                        <input
                            type="text"
                            name="groupName"
                            placeholder="Название группы"
                            required
                            class="w-full bg-black/20 border border-white/10 rounded-2xl py-3 px-4 text-white placeholder-white/30 focus:outline-none focus:bg-black/30 focus:border-white/30 transition-all"
                        />
                    </div>

                    <div id="group-error" class="text-red-300 text-sm h-5"></div> 

                    <button type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-500/30 transition-all flex items-center justify-center gap-2"
                    >
                        Создать Группу (Только для себя) ${createIcon('Plus', 20).outerHTML}
                    </button>
                    <p class="text-xs text-white/50 text-center">
                        * Группа будет видна только вам.
                    </p>
                </form>
            `;
            overlay.appendChild(card);
            
            const closeModal = () => overlay.remove();
            
            overlay.querySelector('#btn-group-close').addEventListener('click', closeModal);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeModal();
            });

            card.querySelector('#group-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = e.target.groupName;
                const errorElement = document.getElementById('group-error');
                
                if (!nameInput.value.trim()) {
                    errorElement.textContent = "Введите название группы.";
                    return;
                }
                
                await handleCreateGroup(nameInput.value);
                closeModal();
            });

            return overlay;
        };


        const renderChatListScreen = () => {
            const container = createElement('div', {}, ['flex', 'flex-col', 'h-screen', 'max-w-4xl', 'mx-auto', 'md:p-6']);
            const chatListWrapper = createElement('div', {}, [
                'flex-1', 'bg-black/40', 'md:bg-white/5', 'md:backdrop-blur-xl', 'md:border', 
                'md:border-white/10', 'md:rounded-3xl', 'flex', 'flex-col', 'overflow-hidden', 'relative', 'shadow-2xl'
            ]);

            // Header and Search
            const header = createElement('div', {}, ['p-4', 'border-b', 'border-white/10', 'bg-white/5', 'backdrop-blur-md', 'sticky', 'top-0', 'z-10']);
            
            header.innerHTML = `
                <div class='flex justify-between items-center mb-4'>
                    <h2 class="text-white text-xl font-bold flex items-center gap-2">
                        ${createIcon('MessageSquare', 20, ['text-pink-400']).outerHTML} Ваши Чаты
                    </h2>
                    <div class='flex gap-2'>
                        <button id="btn-show-group-modal" title="Создать Группу"
                            class="p-2 bg-purple-600 hover:bg-purple-500 rounded-xl text-white transition-colors flex items-center gap-1"
                        >
                            ${createIcon('Users', 18).outerHTML}
                        </button>
                        <button id="btn-back-welcome" title="Вернуться к приветствию"
                            class="p-2 hover:bg-white/10 rounded-xl text-white/70 hover:text-white transition-colors"
                        >
                            ${createIcon('CornerDownLeft', 20).outerHTML}
                        </button>
                        <button id="btn-logout-chats" title="Выход"
                            class="p-2 hover:bg-white/10 rounded-xl text-white/70 hover:text-white transition-colors"
                        >
                            ${createIcon('LogOut', 20).outerHTML}
                        </button>
                    </div>
                </div>

                <div class="relative">
                    ${createIcon('Search', 20, ['absolute', 'left-4', 'top-1/2', '-translate-y-1/2', 'text-white/50']).outerHTML}
                    <input type="text" id="search-input" placeholder="Найти друга по никнейму..."
                        class="w-full bg-black/20 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white placeholder-white/30 focus:outline-none focus:bg-black/30 focus:border-white/30 transition-all"
                    />
                </div>
                <div id="search-results-container" class="absolute top-[120px] left-0 right-0 z-20 bg-slate-800/95 backdrop-blur-lg p-4 shadow-2xl border-b border-white/20 hidden">
                    <!-- Результаты поиска здесь -->
                </div>
            `;
            chatListWrapper.appendChild(header);

            // Chat List
            const listContainer = createElement('div', {}, ['flex-1', 'overflow-y-auto', 'custom-scrollbar', 'p-4', 'space-y-2']);
            
            if (chatList.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-white/50 mt-10">
                        У вас нет активных чатов. Найдите друга по никнейму или создайте группу!
                    </div>
                `;
            } else {
                chatList.forEach(chat => {
                    const item = createElement('div', { 'data-chat-id': chat.id }, [
                        'flex', 'items-center', 'gap-4', 'p-3', 'bg-white/10', 'hover:bg-white/20', 
                        'rounded-xl', 'cursor-pointer', 'transition-colors', 'border', 'border-white/10'
                    ]);

                    const initial = chat.type === 'private' ? chat.name?.[0]?.toUpperCase() : createIcon('Users', 20).outerHTML;
                    const time = chat.updatedAt?.toDate ? chat.updatedAt.toDate().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '...';

                    item.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-lg shadow-md">
                            ${initial}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <h3 class="text-white font-semibold truncate">
                                ${chat.name}
                            </h3>
                            <p class="text-sm text-white/70 truncate">
                                ${chat.lastMessage || 'Начните чат...'}
                            </p>
                        </div>
                        <span class="text-xs text-white/50">
                            ${time}
                        </span>
                    `;
                    item.addEventListener('click', () => handleChatListItemClick(chat));
                    listContainer.appendChild(item);
                });
            }

            chatListWrapper.appendChild(listContainer);
            container.appendChild(chatListWrapper);

            // Event Listeners
            chatListWrapper.querySelector('#btn-back-welcome').addEventListener('click', () => navigateTo('welcome'));
            chatListWrapper.querySelector('#btn-logout-chats').addEventListener('click', () => signOut(auth));
            chatListWrapper.querySelector('#btn-show-group-modal').addEventListener('click', () => {
                document.getElementById('app-container').appendChild(renderCreateGroupModal());
            });

            const searchInput = chatListWrapper.querySelector('#search-input');
            const searchResultsContainer = chatListWrapper.querySelector('#search-results-container');
            searchInput.addEventListener('input', (e) => {
                handleSearchInputChange(e);
                searchResultsContainer.classList.toggle('hidden', e.target.value.length < 3);
            });
            
            return container;
        };

        // --- CHAT SCREEN LOGIC & RENDER ---

        let messagesUnsubscribe = null;
        let chatMessages = [];
        
        const subscribeToMessages = () => {
            if (messagesUnsubscribe) messagesUnsubscribe();
            if (!activeChat) return;

            const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', activeChat.id, 'messages');
            const q = query(messagesRef, orderBy('createdAt'), limit(100));

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                chatMessages = [];
                snapshot.forEach(doc => chatMessages.push({ ...doc.data(), id: doc.id }));
                renderChatMessages(); // Обновляем только список сообщений
            }, (error) => {
                console.error("Ошибка получения сообщений:", error);
            });
        };
        
        const handleSendMessage = async (e) => {
            e.preventDefault();
            const form = e.target;
            const input = form.messageInput;
            const messageText = input.value.trim();

            if (!messageText || !activeChat) return;

            input.value = ''; // Очищаем поле сразу
            
            const messageData = {
                text: messageText,
                createdAt: serverTimestamp(),
                senderId: currentUserId,
                senderName: currentUser.displayName,
            };

            try {
                const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', activeChat.id, 'messages');
                await addDoc(messagesRef, messageData);

                // Обновляем метаданные чата
                const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', activeChat.id);
                await setDoc(chatRef, {
                    lastMessage: messageText,
                    updatedAt: serverTimestamp(),
                }, { merge: true });

            } catch (error) {
                console.error("Ошибка отправки сообщения:", error);
            }
        };

        const renderChatMessages = () => {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';

            chatMessages.forEach((msg) => {
                const isSender = msg.senderId === currentUserId;
                const messageDiv = createElement('div', {}, ['flex', isSender ? 'justify-end' : 'justify-start']);
                
                const time = msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '...';

                messageDiv.innerHTML = `
                    <div class="max-w-[80%] p-3 rounded-xl shadow-lg ${
                        isSender 
                            ? 'bg-purple-600 text-white rounded-br-none' 
                            : 'bg-slate-700/50 text-white rounded-tl-none'
                    }">
                        ${!isSender ? `<div class="font-semibold text-xs mb-1 text-purple-200">${msg.senderName || 'Неизвестный'}</div>` : ''}
                        <p class="text-sm whitespace-pre-wrap">${msg.text}</p>
                        <span class="block text-right text-[10px] opacity-60 mt-1">${time}</span>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
            });

            // Автоматический скролл вниз
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const renderChatScreen = () => {
            // Запускаем подписку при рендере чата
            subscribeToMessages(); 

            const chatName = activeChat.type === 'private' ? activeChat.name : activeChat.name;

            const container = createElement('div', {}, ['flex', 'flex-col', 'h-screen', 'max-w-4xl', 'mx-auto', 'md:p-6']);
            const chatWrapper = createElement('div', {}, [
                'flex-1', 'bg-black/40', 'md:bg-white/5', 'md:backdrop-blur-xl', 'md:border', 
                'md:border-white/10', 'md:rounded-3xl', 'flex', 'flex-col', 'overflow-hidden', 'relative', 'shadow-2xl'
            ]);

            // Header
            const header = createElement('div', {}, ['p-4', 'border-b', 'border-white/10', 'bg-white/5', 'backdrop-blur-md', 'sticky', 'top-0', 'z-10', 'flex', 'items-center']);
            header.innerHTML = `
                <button id="btn-back-chats" class="p-2 hover:bg-white/10 rounded-full text-white/80 transition-colors mr-3">
                    ${createIcon('ChevronLeft', 24).outerHTML}
                </button>
                <div class="flex flex-col">
                    <h2 class="text-white font-bold">${chatName}</h2>
                    <span class="text-xs text-white/50">${activeChat.type === 'private' ? 'Личный чат' : 'Групповой чат'}</span>
                </div>
            `;
            chatWrapper.appendChild(header);

            // Messages Container
            const messagesContainer = createElement('div', { id: 'messages-container' }, ['flex-1', 'overflow-y-auto', 'p-4', 'space-y-4', 'custom-scrollbar']);
            chatWrapper.appendChild(messagesContainer);

            // Input Form
            const inputForm = createElement('form', { id: 'message-form' }, ['p-4', 'bg-white/5', 'border-t', 'border-white/10', 'flex']);
            inputForm.innerHTML = `
                <input type="text" name="messageInput" placeholder="Введите сообщение..."
                    class="flex-1 bg-black/20 border border-white/10 text-white placeholder-white/30 rounded-l-xl p-4 focus:outline-none focus:bg-black/40 focus:border-purple-500/50 transition-all"
                />
                <button type="submit"
                    class="bg-purple-600 hover:bg-purple-500 text-white font-bold px-6 rounded-r-xl shadow-lg shadow-purple-500/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                    ${createIcon('Send', 20).outerHTML}
                </button>
            `;
            chatWrapper.appendChild(inputForm);

            container.appendChild(chatWrapper);

            // Event Listeners
            header.querySelector('#btn-back-chats').addEventListener('click', () => {
                if (messagesUnsubscribe) messagesUnsubscribe(); // Отписываемся
                navigateTo('chatList');
            });
            inputForm.addEventListener('submit', handleSendMessage);
            
            // Первоначальный рендер сообщений
            renderChatMessages(); 

            return container;
        };

        // --- LIFECYCLE & AUTH WATCHER ---

        // 1. Наблюдатель за состоянием аутентификации
        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            updateCurrentUser(user);
            renderApp();
            
            if (user) {
                // Если пользователь вошел, начинаем подписку на чаты
                subscribeToChats();
            } else {
                // Если пользователь вышел, отписываемся от чатов
                if (chatUnsubscribe) chatUnsubscribe();
            }
        });

        // 2. Инициализация (запуск аутентификации по токену)
        const init = async () => {
            setupLiquidBackground();
            
            // Если есть токен, пробуем войти по нему, иначе даем сработать onAuthStateChanged
            if (initialAuthToken) {
                 try {
                    await signInWithCustomToken(auth, initialAuthToken);
                 } catch (e) {
                    console.error("Custom token sign-in failed:", e);
                    // Оставляем isAuthReady = true, чтобы показать экран входа
                    isAuthReady = true;
                    renderApp(); 
                 }
            } else {
                // Если токена нет, просто ждем onAuthStateChanged
                // Для надежности, если onAuthStateChanged не сработал сразу,
                // устанавливаем isAuthReady через 1 секунду.
                setTimeout(() => {
                    if (!isAuthReady) {
                        isAuthReady = true;
                        renderApp();
                    }
                }, 1000);
            }
        };

        window.onload = init;
    </script>
</body>
</html>
